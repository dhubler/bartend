<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-dialog-behavior/paper-dialog-shared-styles.html">

<dom-module id="bartend-drink">
    <template>
        <style include="paper-dialog-shared-styles"></style>
        <style>
        :host {
            display:block;
            padding: 3px;
            min-width: 300px;
            max-width: 300px;
            min-height: 150px;
        }
        .content {
            padding: 20px;
        }
        paper-button {
            background-color: #2196f3;
        }
        .buttonBar {
            display: flex;
            flex-direction: row;
        }
        .ingredient, .progress {
            list-style-type: none;      
        }
        .buttonSpacer {
            flex: 1;
        }        
        </style>
        <iron-pages id="steps" selected="0">
            <div id="auto">
                <ul class="content">
                    <template is="dom-repeat" items="{{drink.auto}}">
                        <li class="ingredient">[[item.ingredient.liquid]]</li>
                        <li class="progress"><paper-progress value="[[item.percentComplete]]"></paper-progress></li>
                    </template>
                </ul>
                <div class="buttonBar">
                    <paper-button raised on-tap="stop">Stop</paper-button>
                    <div class="buttonSpacer"></div>
                    <paper-button raised on-tap="_nextAuto">Next</paper-button>
                </div>
            </div>
            <div id="manual">
                <div class="content">
                    [[manualInstruction]]
                </div>
                <div class="buttonBar">
                    <paper-button raised on-tap="stop">Stop</paper-button>
                    <div class="buttonSpacer"></div>
                    <paper-button raised on-tap="_nextManual">Next</paper-button>
                </div>
            </div>
        </iron-pages>
    </template>
  <script>
    Polymer({
      is: 'bartend-drink',

      behaviors: [
        Polymer.PaperDialogBehavior
      ],

      properties : {
        recipe  : {
          type : Object
        }
      },

      attached: function() {
        this.url = bartend.apiUrl + 'recipe=' + this.recipe.id + '/';
        this.sub = null;
      },

      start: function(scale) {
        var self = this;
        this.$.steps.selected = 0;
        this.manualStepIndex = -1;
        this.manualInstruction = "Please turn on scale.";
        this.totalWeight = 0;
        var r = new XMLHttpRequest();
        r.open("POST", this.url + "make", true);
        r.onreadystatechange = function() {
          if (r.readyState === XMLHttpRequest.DONE) {
            if (r.status === 200) {
                self._loadCurrent();
            } else {
              console.log("error");
            }
          }
        }
        r.send('{"multiplier":' + scale + '}');
      },

      _loadCurrent: function() {
        var self = this;
        var r = new XMLHttpRequest();
        r.open("GET", bartend.apiUrl + "current", true);
        r.onreadystatechange = function() {
          if (r.readyState === XMLHttpRequest.DONE) {
            if (r.status === 200) {
                self.drink = JSON.parse(r.responseText);
                self.auto = self.drink.auto;
                self._subscribe();
            }
          }
        }; 
        r.send();       
      },

      stop: function() {
        var self = this;
        var r = new XMLHttpRequest();
        r.open("POST", bartend.apiUrl + "current/stop", true);
        var self = this;
        r.onreadystatechange = function() {
          if (r.readyState === XMLHttpRequest.DONE) {
            if (r.status === 200) {
                self._done();
            }
          }
        }
        r.send();
      },

      _subscribe: function() {    
          var self = this;
          this.sub = bartend.wsocket().on('bartend-drink', 'current/update', function(update) {
              var autoComplete = true;
              for (var i = 0; i < update.auto.length; i++) {
                self.drink.auto[i].percentComplete = update.auto[i].percentComplete;
                if (!update.auto[i].complete) {
                    autoComplete = false;
                }
                self.notifyPath('drink.auto.' + i + '.percentComplete', self.drink.auto[i].percentComplete);
              }
              if (update.complete) {
                  self._done();
              } else if (autoComplete) {
                  setTimeout(self._nextAuto.bind(self), 1000);                  
              }
          });
      },

      _done: function() {
          if (this.sub != null) {
              bartend.wsocket().off(this.sub);
              this.sub = null;
          }
          this.fire('done');
          this.toggle();
      },

      _nextManual: function() {
        this.manualStepIndex++;
        var total
        if (this.manualStepIndex >= this.drink.manual.length) {
            this.stop();
        } else {
            var step = this.drink.manual[this.manualStepIndex];
            this.totalWeight += step.ingredient.weight;
            this.manualInstruction = "Pour " + step.ingredient.liquid + 
                " until scale reads " + this.totalWeight + ".";
        }
      },

      _nextAuto : function() {
        if (typeof(this.drink.manual) === "undefined") {
            this._done();
        } else {
            this.$.steps.selected = 1;
        }
      }
    });
  </script> 
</dom-module>
