<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">

<dom-module id="bartend-drink">
    <template>
        <style>
        :host {
            display:block;
        }
        paper-button {
            background-color: #81A3E1;
        }

        .buttonBar {
            display: flex;
            flex-direction: row;
        }
        .ingredient, .progress {
            list-style-type: none;      
        }
        .buttonSpacer {
            flex: 1;
        }        
        </style>
        <iron-pages id="steps" selected="0">
            <div id="auto">
                <ul>
                    <template is="dom-repeat" items="{{drink.auto}}">
                        <li class="ingredient">[[item.ingredient.liquid]]</li>
                        <li class="progress"><paper-progress value="[[item.percentComplete]]"></paper-progress></li>
                    </template>
                </ul>
                <div class="buttonBar">
                    <paper-button raised on-tap="stop">Stop</paper-button>
                    <div class="buttonSpacer"></div>
                    <paper-button raised on-tap="_nextAuto">Next</paper-button>
                </div>
            </div>
            <div id="manual">
                [[manualInstruction]]
                <div class="buttonBar">
                    <paper-button raised on-tap="stop">Stop</paper-button>
                    <div class="buttonSpacer"></div>
                    <paper-button raised on-tap="_nextManual">Next</paper-button>
                </div>
            </div>
        </iron-pages>
    </template>
  <script>
    Polymer({
      is: 'bartend-drink',

      properties : {
        recipe  : {
          type : Object
        }
      },

      attached: function() {
        this.url = bartend.apiUrl + 'recipe=' + this.recipe.id + '/';
      },

      start: function() {
        var self = this;
        this.$.steps.selected = 0;
        this.manualStepIndex = -1;
        this.manualInstruction = "Please turn on scale.";
        this.totalWeight = 0;
        var r = new XMLHttpRequest();
        r.open("POST", this.url + "make", true);
        r.onreadystatechange = function() {
          if (r.readyState === XMLHttpRequest.DONE) {
            if (r.status === 200) {
                self._loadCurrent();
            } else {
              console.log("error");
            }
          }
        }
        r.send();
      },

      _loadCurrent: function() {
        var self = this;
        var r = new XMLHttpRequest();
        r.open("GET", bartend.apiUrl + "current", true);
        r.onreadystatechange = function() {
          if (r.readyState === XMLHttpRequest.DONE) {
            if (r.status === 200) {
                self.drink = JSON.parse(r.responseText);
                self.auto = self.drink.auto;
                self._subscribe();
            }
          }
        }; 
        r.send();       
      },

      stop: function() {
        var self = this;
        var r = new XMLHttpRequest();
        r.open("POST", bartend.apiUrl + "current/stop", true);
        var self = this;
        r.onreadystatechange = function() {
          if (r.readyState === XMLHttpRequest.DONE) {
            if (r.status === 200) {
                self._done();
            }
          }
        }
        r.send();
      },

      _subscribe: function() {    
          var self = this;
          var driver = new WebSocket(bartend.wsUrl);
          this.notification = new notify.handler(driver);
          this.notification.done = function() {
              self.notification.close();
          };
          this.notification.on('bartend', 'current/update', function(update) {
              for (var i = 0; i < update.auto.length; i++) {
                self.drink.auto[i].percentComplete = update.auto[i].percentComplete;
                self.notifyPath('drink.auto.' + i + '.percentComplete', self.drink.auto[i].percentComplete);
              }
          });
      },

      _done: function() {
          if (typeof(this.notification) != "undefined") {
              this.notification.close();
          }
          this.fire('done');
      },

      _nextManual: function() {
        this.manualStepIndex++;
        var total
        if (this.manualStepIndex >= this.drink.manual.length) {
            this.stop();
        } else {
            var step = this.drink.manual[this.manualStepIndex];
            this.totalWeight += step.ingredient.weight;
            this.manualInstruction = "Pour " + step.ingredient.liquid + 
                " until scale reads " + this.totalWeight + ".";
        }
      },

      _nextAuto : function() {
        if (typeof(this.drink.manual) === "undefined") {
            this._done();
        } else {
            this.$.steps.selected = 1;
        }
      }
    });
  </script> 
</dom-module>
