<link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bartend-recipe/bartend-recipe.html">
<link rel="import" href="../bartend-pump/bartend-pump.html">

<!--
    `<bartend-app>` show all recipes and pumps from bartender machine.
        You only need one of these per application and it accepts no 
        parameters.
-->    
<dom-module id="bartend-app">
  <template>
    <style>
        :host {
            display: block;
        }
        .link {
            color: #ffffff;
            text-align: center;
            font-size: large;
            margin-top: 15px;
        }
        .card {
            display: block;
            margin: 5px;
        }    
        paper-tabs {
            background-color: #2196f3;
            text-transform: uppercase;
        }
    </style>
    <paper-tabs id="menu" selected="{{_selected}}">
        <paper-tab link><a href="#recipes" class="link" tabindex="-1">Recipes</a></paper-tab>
        <paper-tab link><a href="#setup" class="link" tabindex="-1">Setup</a></paper-tab>
    </paper-tabs>
    <paper-toast id="msg"></paper-toast>
    <iron-pages selected="{{_selected}}">
        <div class="layout vertical" id="recipes">
            <template is="dom-repeat" items="{{_data.recipe}}">
                <paper-card class="flex card">
                    <bartend-recipe recipe="{{item}}"></bartend-recipe>
                </paper-card>
            </template>
        </div>
        <div class="layout vertical" id="setup">            
            <template is="dom-repeat" items="{{_data.pump}}">
                <paper-card class="flex card">
                    <bartend-pump pump="{{item}}" liquids="[[_data.liquids]]"></bartend-pump>
                </paper-card>
            </template>
        </div>
    </iron-pages>
  </template>
  <script>
    class BartendApp extends Polymer.GestureEventListeners(Polymer.Element) {

        static get is() {
            return 'bartend-app';
        }

        static get properties() {
            return  {
                _selected : {
                    type: Number,
                    value: 0
                },
                _data : {
                    type: Object,
                    value: function() {
                        return {};
                    }
                }
            }
        }

        ready() {
            super.ready();
            var self = this;
            fetch(bartend.apiUrl).then((resp) => {
                resp.json().then((data) => {
                    self._data = data;
                    self.notifyPath("_data.pump");
                    self._subscribe();
                });
            }).catch(self._err.bind(self));
        }

        _err(err) {
            console.log(err);
        }

        // watch bartender for drink updates
        _subscribe() {
            var self = this;
            var complete = false;
            bartend.wsocket().on('bartend-app', 'current/update', 'bartend', function(update, err) {
                if (err != null) {
                    console.log(err);
                    return
                }                
                if (update == null) {
                    return
                }
                if (update.complete != self.complete) {
                    if (update.complete) {
                        self.$.msg.text = "Drink complete";
                    } else {
                        self.$.msg.text = "Drink in progress...";
                    }
                    self.complete = update.complete;
                    self.$.msg.open();
                }
            });
        }
    }
    customElements.define(BartendApp.is, BartendApp);
  </script>
</dom-module>

